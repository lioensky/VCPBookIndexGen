# 长小说索引生成器 (Novel Indexer)

该项目用于将超巨幅长篇小说（几百万字甚至更大）安全、完整地切分并总结，最终构建出一个具备“全书梗概-章节梗概-原文碎块”的层级结构索引。

这一系统能够帮大型语言模型 (LLMs) 在上下文窗口受限的情况下，完成对整本小说的阅读与记忆构建。生成的产物无缝兼容未来的向量数据库 (RAG) 预处理标准。

## 🌟 核心特性
1. **智能目录嗅探**：自带多套高权重正则探测（支持第一章、第X回、Chapter N，以及特殊的“楔子、序章、终章”）。即使在第一章之前存在前言、作者简介等，也会被自动打包收录。
2. **文本抗截断切块 (`TextChunker`)**：依据设定的 `CHUNK_SIZE` 并在段落/句子边界处平滑切割，保障语义不会硬断裂。
3. **速读模式 (`speed`)**：章节之间无上下文依赖，使用 `asyncio` 并发处理多章节，速度极快。
4. **精读模式 (`deep`)的滚动记忆**：**串行处理**，每读完一章会带着前文累加的“故事总结片段 (`rolling_context`)”读下一章；为了防止前文无限膨胀，引擎还会在超限时执行自我浓缩算法 (Summarize over Summaries)。
5. **断点无损续传**：基于 `progress.json`。哪怕遇到网络中断，再次运行也会精准加载最后一次深读模式残留的记忆与进度，不浪费 Token。
6. **千章递归合并**：专门针对“将5000章的单章总结融合成全书大纲”引发的 Prompt 超限问题，它采用金字塔状递推机制进行逐级缩减归并。

## 🛠️ 安装

```bash
# 1. 确保已安装 Python 3.9+
# 2. 安装项目依赖
pip install -r requirements.txt
```

## ⚙️ 环境配置
将 `.env.example` 重命名为 `.env`，并在其中填入你的大模型 API 密钥：

```ini
LLM_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxx
LLM_BASE_URL=https://api.openai.com/v1
LLM_MODEL=gpt-4o-mini
```

> 其中 `CHUNK_SIZE` 决定了每个原文碎片的大小（为了以后送去 Embedding）。  
> `MAX_CONCURRENCY` 为速读时的协程并发数限制。

## 🚀 CLI 命令行用法

### 1. 基础用法 (交互式目录确认)
默认读取 `.env` 中的模式配置运行。提取出目录后会在终端停留，让你确认目录捕捉是否完整且正确。
```bash
python main.py <你的小说.txt> 

# 例如
python main.py ./斗破苍穹.txt
```

### 2. 指定阅读模式并静默运行
使用 `--mode` 覆盖全局设定，使用 `--skip-confirm` 不要提示确认，直接“一条龙”跑完：
```bash
python main.py ./斗破苍穹.txt --mode deep --skip-confirm
```

### 3. 指定最终输出的项目书名
如果你觉得原始 TXT 的名字不美观或者是乱码，可以在索引生成时强行指定生成的书名目录名：
```bash
python main.py ./novel_12345.txt --name "斗破苍穹"
```

### 4. 注入非主流的正则章名
如果这部小说没用普通的“第X章”，而是特殊的起名法，你可以自己写一条正则表达式教它提取（必须使用 Python Regex 语法，并通过捕获组捕获章节名）：
```bash
python main.py ./某小说.txt --pattern "^卷\d+[\s:：·—-]*(.*)"
```

## 📂 输出结构
```text
output/
└── {书名}-索引/
    ├── progress.json                            # 断点续传核心状态（深读记忆）
    ├── {书名}-章节目录.md                        # LLM 提取清洗好的大纲
    ├── {书名}-全书剧情总结.md                    # L0宏观视角：给 Agent 看的概述
    ├── {书名}-000-作品相关_前言-总结.md          # L1与L2微观视角：单章总结与内容分块
    ├── {书名}-000-作品相关_前言-原文块-1.md
    ├── {书名}-001-第一章 潜龙出渊-总结.md
    ├── {书名}-001-第一章 潜龙出渊-原文块-1.md
    ├── {书名}-001-第一章 潜龙出渊-原文块-2.md
    └── ...
```
